networks:
  bigdata:
    driver: bridge

services:
  postgres:
    image: postgres:14
    container_name: postgres
    environment:
      POSTGRES_DB: hive
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
    ports: ["5432:5432"]
    networks: [bigdata]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d hive"]
      interval: 5s
      timeout: 5s
      retries: 20

  # Hadoop (BDE images, unchanged)
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: namenode
    environment: [CLUSTER_NAME=hadoop]
    ports: ["9870:9870","8020:8020"]
    volumes: [namenode:/hadoop/dfs/name]
    networks: [bigdata]

  datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: datanode
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - SERVICE_PRECONDITION=namenode:9870
    ports: ["9864:9864"]
    volumes: [datanode:/hadoop/dfs/data]
    networks: [bigdata]
    depends_on: [namenode]

  resourcemanager:
    image: bde2020/hadoop-resourcemanager:2.0.0-hadoop3.2.1-java8
    container_name: resourcemanager
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - YARN_CONF_yarn_resourcemanager_hostname=resourcemanager
      - SERVICE_PRECONDITION=namenode:9870 datanode:9864
    ports: ["8088:8088"]
    networks: [bigdata]
    depends_on: [namenode, datanode]

  nodemanager:
    image: bde2020/hadoop-nodemanager:2.0.0-hadoop3.2.1-java8
    container_name: nodemanager
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - YARN_CONF_yarn_resourcemanager_hostname=resourcemanager
      - SERVICE_PRECONDITION=namenode:9870 datanode:9864 resourcemanager:8088
    networks: [bigdata]
    depends_on: [resourcemanager]

  # Hive Metastore (Postgres)
  hive-metastore:
    image: apache/hive:3.1.3
    container_name: hive-metastore
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      # Connection properties passed to Hive as JVM opts
      SERVICE_OPTS: >-
        -Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver
        -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://postgres:5432/hive
        -Djavax.jdo.option.ConnectionUserName=hive
        -Djavax.jdo.option.ConnectionPassword=hive
      # Mount our Hadoop conf into Hive
      HIVE_CUSTOM_CONF_DIR: /hive_custom_conf
    volumes:
      - ./conf/hadoop:/hive_custom_conf:ro
      - ./conf/postgresql-42.5.1.jar:/opt/hive/lib/postgres.jar:ro
    ports: ["9083:9083"]
    networks: [bigdata]
    depends_on:
      postgres:
        condition: service_healthy
      resourcemanager:
        condition: service_started

  # HiveServer2 (JDBC on 10000)
  hive-server:
    image: apache/hive:3.1.3
    container_name: hive-server
    environment:
      SERVICE_NAME: hiveserver2
      IS_RESUME: "true"
      # Tell HS2 to use the remote metastore
      SERVICE_OPTS: >-
        -Dhive.metastore.uris=thrift://hive-metastore:9083
      HIVE_CUSTOM_CONF_DIR: /hive_custom_conf
    volumes:
      - ./conf/hadoop:/hive_custom_conf:ro
    ports: ["10000:10000","10002:10002"]  # JDBC + HS2 web UI
    networks: [bigdata]
    depends_on: [hive-metastore]

volumes:
  namenode:
  datanode:
